{% extends 'base.html' %}
{% block content %}
<div class="container my-4">
  <div class="card shadow-sm">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">Payment</h5>
    </div>
    <div class="card-body text-center">
      <h6>Order ID: <strong>{{ order_id }}</strong></h6>
      <p><strong>Name:</strong> {{ address.name }}</p>    
      <p><strong>Phone:</strong> {{ address.phone }}</p>
      <p><strong>Address:</strong> {{ address.address }}</p>
      <p><strong>Total Amount:</strong> â‚¹{{ total }}</p>

      <hr>
      <h6>Scan & Pay (UPI)</h6>
      <div class="mb-3">
        <img src="{{ url_for('upi_qr') }}" id="qrCode" alt="QR Code" class="img-fluid" style="max-width:250px;">
        <p class="mt-2">UPI ID: <strong>{{ upi }}</strong></p>
        <p id="timer" class="text-danger fw-bold"></p>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Payment Form -->
      <form id="paymentForm" method="POST" action="{{ url_for('confirm') }}">
        <div class="mb-3 text-start">
          <label for="utr" class="form-label">Enter UTR (12-digit transaction ID)</label>
          <input type="text" name="utr" id="utr" class="form-control" placeholder="Enter UTR" pattern="\d{12}" maxlength="12">
        </div>

        <div class="text-center my-2 fw-bold">OR</div>

        <div class="form-check text-start mb-3">
          <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod">
          <label class="form-check-label" for="cod">Cash on Delivery</label>
        </div>

        <div class="d-flex justify-content-center mt-4">
          <button type="submit" class="order" id="orderBtn" aria-label="Complete Order">
            <span class="default">Complete Order</span>
            <span class="success">Order Placed
              <svg viewBox="0 0 12 10"><polyline points="1.5 6 4.5 9 10.5 1"></polyline></svg>
            </span>

            <div class="box" aria-hidden="true"></div>

            <div class="truck" aria-hidden="true">
              <div class="back"></div>
              <div class="front"><div class="window"></div></div>
            </div>

            <div class="lines" aria-hidden="true"></div>
          </button>
        </div>
      </form>

      <div class="mt-3">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Shop</a>
      </div>
    </div>
  </div>
</div>

<!-- ================= Success Modal ================= -->
<div id="orderSuccessModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="tick-circle">
      <div class="tick">&#10003;</div>
    </div>
    <h4>Order Placed Successfully!</h4>
  </div>
</div>

<!-- ================= CSS ================= -->
<style>
/* ================= Order Button & Truck Styles ================= */
.order {
  position: relative;
  display: inline-block;
  width: 300px;
  height: 64px;
  border-radius: 36px;
  border: none;
  background: #198754;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  overflow: hidden;
  text-align: center;
  padding: 0;
}
.order:focus { outline: none; box-shadow: 0 0 0 3px rgba(25,135,84,0.18); }

.order span.default { line-height: 64px; display:block; transition: opacity .25s ease; }
.order span.success {
  position: absolute;
  left: 50%; top: 50%;
  transform: translate(-50%,-50%);
  opacity: 0;
  display: inline-flex;
  gap: 8px;
  align-items: center;
  font-weight:700;
}
.order span.success svg { width:16px;height:14px; stroke:#fff; fill:none; stroke-width:2; }

.order.animate span.default { opacity: 0; }
.order.animate span.success { opacity: 1; transition: opacity .25s ease .9s; }

.order .truck {
  position: absolute;
  bottom: 6px;
  left: -220px;
  width: 90px;
  height: 46px;
  display: flex;
  align-items: flex-end;
  justify-content: flex-start;
  pointer-events: none;
  opacity: 0;
}
.order .truck .back {
  width: 54px;
  height: 34px;
  background: linear-gradient(#555,#444);
  border-radius: 6px 0 0 6px;
}
.order .truck .front {
  width: 36px;
  height: 34px;
  background: linear-gradient(#d33,#b22);
  border-radius: 0 6px 6px 0;
  position: relative;
}
.order .truck .window {
  position: absolute;
  left: 6px; top: 4px;
  width: 18px; height: 14px;
  background: rgba(255,255,255,0.85);
  border-radius: 2px;
  transform: skewY(-6deg);
}
.order .truck::before, .order .truck::after{
  content:"";
  position:absolute;
  bottom:-8px;
  width:14px; height:14px;
  background:#111;
  border-radius:50%;
}
.order .truck::before { left: 12px; }
.order .truck::after  { right: 6px; }

.order .box {
  width: 22px; height: 22px;
  background: linear-gradient(#f6b24a,#f39b1f);
  position: absolute;
  left: 24px;
  bottom: 28px;
  border-radius:3px;
  opacity: 0;
}

.order .lines {
  position:absolute;
  left:0; right:0; top:0; bottom:0;
  opacity:0;
  background: repeating-linear-gradient(90deg, transparent 0 6px, rgba(255,255,255,0.14) 6px 12px);
}

.order.animate .box {
  opacity: 1;
  animation: box-move 0.9s ease forwards 0.1s;
}
@keyframes box-move {
  0%   { transform: translateX(0) translateY(0); opacity:1; }
  55%  { transform: translateX(58px) translateY(-18px); opacity:1; }
  90%  { transform: translateX(92px) translateY(-18px); opacity:0; }
  100% { opacity:0; }
}
.order.animate .truck {
  opacity:1;
  animation: truck-drive 3.2s cubic-bezier(.22,.9,.32,1) forwards 0.6s;
}
@keyframes truck-drive {
  0%   { transform: translateX(0px); }
  35%  { transform: translateX(140px); }
  100% { transform: translateX(520px); }
}
.order.animate .lines {
  opacity: 1;
  animation: lines-move 1.6s linear infinite 0.6s;
}
@keyframes lines-move {
  0% { background-position: 0 0; }
  100% { background-position: -40px 0; }
}
.order.animate { pointer-events: none; }

.is-invalid {
  border: 2px solid #dc3545 !important;
  animation: shake 0.3s;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
}

/* ================= Success Modal ================= */
.modal-overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:1000;
}

.modal-content {
  background:#fff;
  padding:30px 40px;
  border-radius:12px;
  text-align:center;
  min-width:250px;
  animation: popIn 0.3s ease;
}

.tick-circle {
  width: 70px;
  height: 70px;
  border: 3px solid #28a745;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto 15px auto;
}

.tick {
  font-size: 40px;
  color: #28a745;
  line-height: 1;
}

@keyframes popIn {
  0% { transform: scale(0.5); opacity:0; }
  100% { transform: scale(1); opacity:1; }
}
</style>

<!-- ================= JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const expiryTime = {{ expiry_time|tojson|default('null') }};
  const timerEl = document.getElementById('timer');
  const qrEl = document.getElementById('qrCode');
  const formEl = document.getElementById('paymentForm');
  const utrInput = document.getElementById('utr');
  const codInput = document.getElementById('cod');
  const orderBtn = document.getElementById('orderBtn');

  if (expiryTime !== null) {
    function updateTimer() {
      const now = Date.now() / 1000;
      const diff = Math.floor(expiryTime - now);
      if (diff <= 0) {
        timerEl.textContent = 'QR code expired. Please regenerate.';
        qrEl.style.display = 'none';
        formEl.style.display = 'none';
        clearInterval(timerInterval);
        return;
      }
      const minutes = Math.floor(diff/60);
      const seconds = diff % 60;
      timerEl.textContent = `QR code expires in ${minutes}:${String(seconds).padStart(2,'0')}`;
    }
    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  }

  orderBtn.addEventListener('click', function (ev) {
    ev.preventDefault();
    const utr = utrInput.value.trim();
    const codSelected = codInput.checked;

    if (!/^\d{12}$/.test(utr) && !codSelected) {
      utrInput.classList.add("is-invalid");
      utrInput.focus();
      return;
    } else {
      utrInput.classList.remove("is-invalid");
    }

    if (orderBtn.classList.contains('animate')) return;

    orderBtn.classList.add('animate');

    // Show success modal after truck animation
    setTimeout(() => {
      const modal = document.getElementById('orderSuccessModal');
      modal.style.display = 'flex';

      // Auto-close modal after 2s
      setTimeout(() => {
        modal.style.display = 'none';
        formEl.submit();
      }, 2000);
    }, 4200);
  });
});
</script>
{% endblock %}
